{"version":3,"file":"mapbox-gl-vector-custom-protocol.min.js","sources":["../../src/index.ts"],"sourcesContent":["import {\n    default as maplibregl,\n    Tile,\n    Callback,\n    RequestParameters,\n    ResponseCallback,\n    Cancelable,\n    VectorSourceSpecification,\n    Dispatcher,\n    Evented\n} from 'maplibre-gl';\n\ntype LoadFnType = (requestParameters: RequestParameters, callback: ResponseCallback<any>) => Cancelable;\n\nconst vectorCustomProtocol = (mapLibrary: typeof maplibregl) => {\n\n    // Adds the protocol tools to the mapLibrary, doesn't overwrite them if they already exist\n    let protocols = new Map<string, ((requestParameters: RequestParameters, callback: ResponseCallback<any>) => Cancelable)>();\n    const alreadySupported = mapLibrary.addProtocol !== undefined;\n    if (!alreadySupported) {\n        mapLibrary.addProtocol = mapLibrary.addProtocol || ((customProtocol: string, loadFn: LoadFnType) => {\n            protocols.set(customProtocol, loadFn);\n        });\n        mapLibrary.removeProtocol = mapLibrary.removeProtocol || ((customProtocol: string) => {\n            protocols.delete(customProtocol);\n        });\n    }\n    return class VectorCustomProtocolSourceSpecification extends mapLibrary.Style.getSourceType('vector') {\n\n        constructor(id: string, options: VectorSourceSpecification & {collectResourceTiming: boolean}, dispatcher: Dispatcher, eventedParent: Evented) {\n            super(id, options, dispatcher, eventedParent);\n        }\n\n        loadTile(tile: Tile, callback: Callback<void>) {\n            const rawUrl = tile.tileID.canonical.url((this as any).tiles, (this as any).scheme);\n            const protocol = rawUrl.substring(0, rawUrl.indexOf('://'));\n            if (!alreadySupported && protocols.has(protocol)) {\n                // Probably using Mapboxgljs\n                // There's a matching URL\n                const loadFn = protocols.get(protocol) as LoadFnType;\n                const requestParameters:RequestParameters = {\n                    url: rawUrl,\n                    type: 'arrayBuffer',\n\n                };\n                const urlCallback = (error?: Error | null, data?: ArrayBuffer, cacheControl?: string | null, expires?: string | null) => {\n                    if (error) {\n                        throw error;\n                    } else {\n                        const byteArray = new Uint8Array(data as ArrayBuffer);\n                        const url = URL.createObjectURL(new Blob([byteArray]));\n                        tile.tileID.canonical.url = function () {\n                            delete (tile.tileID.canonical as any).url;\n                            return url;\n                        };\n\n                        super.loadTile(tile, function() {\n                            URL.revokeObjectURL(url);\n                            callback(...arguments);\n                        });\n                    }\n                };\n                loadFn(requestParameters, urlCallback);\n            } else {\n                super.loadTile(tile, callback);\n            }\n        }\n    };\n};\n\nexport default vectorCustomProtocol;"],"names":["mapLibrary","protocols","Map","alreadySupported","undefined","addProtocol","customProtocol","loadFn","set","removeProtocol","delete","Style","getSourceType","constructor","id","options","dispatcher","eventedParent","super","loadTile","tile","callback","rawUrl","tileID","canonical","url","this","tiles","scheme","protocol","substring","indexOf","has","urlCallback","error","data","cacheControl","expires","byteArray","Uint8Array","URL","createObjectURL","Blob","revokeObjectURL","arguments","get","type"],"mappings":"4PAc8BA,IAG1B,IAAIC,EAAY,IAAIC,IACpB,MAAMC,OAA8CC,IAA3BJ,EAAWK,YASpC,OARKF,IACDH,EAAWK,YAAcL,EAAWK,eAAiBC,EAAwBC,KACzEN,EAAUO,IAAIF,EAAgBC,KAElCP,EAAWS,eAAiBT,EAAWS,iBAAoBH,IACvDL,EAAUS,OAAOJ,MAGlB,cAAsDN,EAAWW,MAAMC,cAAc,WAExFC,YAAYC,EAAYC,EAAuEC,EAAwBC,GACnHC,MAAMJ,EAAIC,EAASC,EAAYC,GAGnCE,SAASC,EAAYC,GACjB,MAAMC,EAASF,EAAKG,OAAOC,UAAUC,IAAKC,KAAaC,MAAQD,KAAaE,QACtEC,EAAWP,EAAOQ,UAAU,EAAGR,EAAOS,QAAQ,QACpD,IAAK5B,GAAoBF,EAAU+B,IAAIH,GAAW,CAG9C,MAMMI,EAAc,CAACC,EAAsBC,EAAoBC,EAA8BC,KACzF,GAAIH,EACA,MAAMA,EACH,CACH,MAAMI,EAAY,IAAIC,WAAWJ,GAC3BV,EAAMe,IAAIC,gBAAgB,IAAIC,KAAK,CAACJ,KAC1ClB,EAAKG,OAAOC,UAAUC,IAAM,WAExB,cADQL,EAAKG,OAAOC,UAAkBC,IAC/BA,GAGXP,MAAMC,SAASC,GAAM,WACjBoB,IAAIG,gBAAgBlB,GACpBJ,KAAYuB,gBAnBT3C,EAAU4C,IAAIhB,EAuB7BtB,CAtB4C,CACxCkB,IAAKH,EACLwB,KAAM,eAoBgBb,QAE1Bf,MAAMC,SAASC,EAAMC"}